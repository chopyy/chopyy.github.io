<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Realtime-Preempt Kernel on Raspberry PI - dtuchsch memo</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Realtime-Preempt Kernel on Raspberry PI";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> dtuchsch memo</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Quadrocopter</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../quadrocopter/Getting-Started-with-PX4-Toolchain/">Getting Started PX4</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>ROS</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../ros/Installing-ROS/">Installing ROS indigo</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Linux</span></li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Realtime-Preempt Kernel on Raspberry PI</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#enable-real-time-capabilities-of-the-mainline-kernel-on-the-raspberry-pi">Enable real-time capabilities of the mainline kernel on the Raspberry PI</a></li>
                
                    <li><a class="toctree-l4" href="#downloading-and-patching">Downloading and Patching</a></li>
                
                    <li><a class="toctree-l4" href="#running-and-testing">Running and Testing</a></li>
                
                    <li><a class="toctree-l4" href="#cross-compiler_1">Cross-Compiler</a></li>
                
                    <li><a class="toctree-l4" href="#configuration_1">Configuration</a></li>
                
                    <li><a class="toctree-l4" href="#compiling_1">Compiling</a></li>
                
            
                <li class="toctree-l3"><a href="#references">References</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">dtuchsch memo</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Linux &raquo;</li>
        
      
    
    <li>Realtime-Preempt Kernel on Raspberry PI</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="enable-real-time-capabilities-of-the-mainline-kernel-on-the-raspberry-pi">Enable real-time capabilities of the mainline kernel on the Raspberry PI</h1>
<p>Embedded systems often need hard realtime capabilities for driving actuators or reading out sensor data at a given time. This guideline shows how to apply the realtime kernel from OSADL on a Raspberry PI (RPI) v2. We will go through downloading the sources, cross-compiling the kernel on a PC architecture and finally flashing it on the RPI.</p>
<p>I'm cross-compiling the kernel on an Intel i7 CPU with 8 GB of RAM in Ubuntu as my host system, because it will compile a lot faster than compiling the kernel on the RPI itself. As embedded device I'm using a Raspberry PI v2 Model B.</p>
<h2 id="downloading-and-patching">Downloading and Patching</h2>
<p>There are several possible kernels you can use for building a kernel with PREEMPT RT. The easiest way to get a realtime kernel running on the RPI is to use the raspberry kernel from their GitHub repositories. Another way is to use the Vanilla kernel, but you have to add all extras and the Raspberry firmware by yourself. So, this guide is separated in two main parts. In the first part of this guide I will describe the way for patching and building the realtime kernel with the kernel source from the GitHub repository of Raspberry. In the second part I describe the more generic way to get the Vanilla kernel also running. But there are some more things to do and the work is in progress.</p>
<h3 id="raspberry-kernel">Raspberry kernel</h3>
<p>Download the Raspberry kernel from GitHub:</p>
<pre><code class="shell">cd /usr/src/
mkdir kernels
cd kernels
git clone --depth=1 https://github.com/raspberrypi/linux
</code></pre>

<p>Look for the kernel version of the kernel. You will find the information within the Makefile and it should look something like:</p>
<pre><code>VERSION = 3
PATCHLEVEL = 18
SUBLEVEL = 11
</code></pre>

<p>So in my case I will need the realtime patch 3.18.11:</p>
<pre><code class="shell">cd /usr/src/kernels
sudo wget https://www.kernel.org/pub/linux/kernel/projects/rt/3.18/older/patch-3.18.11-rt7.patch.xz
</code></pre>

<p>If your kernel version differs from the one described in this guide, search for the appropriate kernel patch on https://www.kernel.org/pub/linux/kernel/projects/rt/ and download it like described above.</p>
<p>Rename the folder you cloned from GitHub, because we will patch it in the next step:</p>
<pre><code class="shell">cd /usr/src/kernels
sudo mv linux linux-rt
</code></pre>

<p>Go into your linux-rt directory and patch it with the downloaded RT PREEMPT patch:</p>
<pre><code class="shell">sudo -i
cd /usr/src/kernels/linux-3.18.11-rt/
sudo xz -dc /usr/src/kernels/patch-3.18.11-rt7.patch.xz | patch -p1
</code></pre>

<p><strong>Note:</strong> This step has to be executed as root explicitly (sudo -i).</p>
<h4 id="cross-compiler">Cross Compiler</h4>
<p>There is more than one ARM cross compiler for Ubuntu Linux. We will use the provided compiler from the <em>Raspberry Pi tools section</em> on GitHub.</p>
<pre><code class="shell">cd /opt/
git clone git://github.com/raspberrypi/tools.git --depth 1
</code></pre>

<h4 id="configuration">Configuration</h4>
<p>Now comes the exciting part: Configuring the kernel! But before you are able to configure the kernel and activate the realtime capabilities, make sure you installed all necessary dependencies and get the linux kernel ready to compile:</p>
<pre><code class="shell">sudo apt-get install libncurses5-dev
make mrproper
</code></pre>

<p>Set an environment variable for the prefix of the cross compiler toolchain:</p>
<pre><code class="shell">export CCPREFIX=/opt/rpi-tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/arm-linux-gnueabihf-
</code></pre>

<p>Make an initial config for the Raspberry build:</p>
<pre><code class="shell">sudo make ARCH=arm CROSS_COMPILE=${CCPREFIX} bcm2709_defconfig
</code></pre>

<p>In the same terminal where you exported the environment variable run your first make command to configure your realtime kernel:</p>
<pre><code class="shell">KERNEL=kernel7
sudo make ARCH=arm CROSS_COMPILE=${CCPREFIX} menuconfig
</code></pre>

<p>This make target will start up a graphical interface shown below: </p>
<p><img alt="" src="../gfx/Menuconfig_Start.png" /></p>
<p>If you configured the ARM build correctly the Preemption Model of the PREEMPT patch can be found under <em>Kernel Features</em> and then <strong>Preemption Model</strong> like shown in the following image:</p>
<p><img alt="" src="../gfx/Preemption_Model_menuconfig_ARM.png" /></p>
<p>Choose <strong>Fully Preemptible Kernel (RT)</strong> here.</p>
<p><strong>Note:</strong> If this option is not available the patch was not successful and something went wrong. Try to patch the downloaded kernel once again.</p>
<h4 id="compiling">Compiling</h4>
<p>You can now compile the kernel on the PC. If you are working on a multi-processor platform enable parallel jobs for a quicker build switching on <em>-j #n</em> where #n is the number of parallel jobs that will be used. This should be 1.5 times your number of cores. Using this option makes the build about 48% faster on a modern Intel/AMD processor. Now you can imagine how long it would take to compile the kernel directly on the RPI itself (more than 3 hrs I guess).</p>
<p>For the raspberry kernel simply execute the following commands:</p>
<pre><code class="shell">cd /usr/src/kernels/linux-rt
sudo make ARCH=arm CROSS_COMPILE=${CCPREFIX} zImage modules dtbs -j5
</code></pre>

<p>After successful compilation the compiled kernel is located under <em>arch/arm/boot/</em>.</p>
<h4 id="flash-the-compiled-kernel">Flash the compiled kernel</h4>
<p>After compiling the kernel we can flash the image onto the RPI. First, plug in your SD card from RPI:</p>
<pre><code class="shell">lsblk
</code></pre>

<p>You should see something like this:</p>
<pre><code class="shell">NAME
mmcblk0
|-mmcblk0p1
|-mmcblk0p2
</code></pre>

<p>Mount both drives:</p>
<pre><code class="shell">mkdir mnt/fat32
mkdir mnt/ext4
sudo mount /dev/sdb1 mnt/fat32
sudo mount /dev/sdb2 mnt/ext4
</code></pre>

<p>Install the modules of the compiled kernel:</p>
<pre><code class="shell">sudo make ARCH=arm CROSS_COMPILE=${CCPREFIX} INSTALL_MOD_PATH=media/dtuchscherer/13d368bf-6dbf-4751-8ba1-88bed06bef77/ modules_install
sudo make ARCH=arm CROSS_COMPILE=${CCPREFIX} INSTALL_MOD_PATH=mnt/ext4 modules_install
</code></pre>

<p>Back up your old kernel and copy the realtime kernel onto the SD card:</p>
<pre><code class="shell">cd /usr/src/kernels/linux-rt
sudo cp /media/dtuchscherer/boot/$KERNEL.img /media/dtuchscherer/boot/$KERNEL-backup.img
sudo scripts/mkknlimg arch/arm/boot/zImage /media/dtuchscherer/boot/$KERNEL-rt.img
sudo cp arch/arm/boot/dts/*.dtb /media/dtuchscherer/boot/
sudo cp arch/arm/boot/dts/overlays/*.dtb* /media/dtuchscherer/boot/overlays/
</code></pre>

<p>Finally, adjust the config file:</p>
<pre><code class="shell">kernel=kernel-rt.img
</code></pre>

<h2 id="running-and-testing">Running and Testing</h2>
<p>After you transferred the kernel onto the RPI, plug in your SD card and boot the controller. Test if the kernel and the realtime patch was successful:</p>
<pre><code class="shell">uname -a
</code></pre>

<p>It should show something similiar to this:</p>
<pre><code class="shell">Linux raspberrypi 3.18.14-rt7-v7+ #1 SMP PREEMPT RT Fri Jun 12 12:08:45 CEST 2015 armv7l GNU/Linux
</code></pre>

<p>There are tools for testing if the patch was successful. Log in to your RPI over SSH and clone the following GitHub repository:</p>
<pre><code class="shell">ssh pi@141.7.28.126
git clone git://git.kernel.org/pub/scm/linux/kernel/git/clrkwllms/rt-tests.git
cd rt-tests
make
</code></pre>

<h3 id="vanilla-kernel">Vanilla kernel</h3>
<p><strong>Note:</strong> This work is in progress and will be released later on.
&lt;!--
Download both the kernel as well as the corresponding RT patch. We will work with <strong>kernel version 3.18.11</strong>:</p>
<pre><code class="shell">cd /usr/src/kernels
sudo wget https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.18.11.tar.xz
sudo wget https://www.kernel.org/pub/linux/kernel/projects/rt/3.18/older/patch-3.18.11-rt7.patch.xz
</code></pre>

<p>If directory kernels does not exist create it:</p>
<pre><code class="shell">cd /usr/src/
mkdir kernels
</code></pre>

<p>Unpack the kernel:</p>
<pre><code class="shell">sudo tar -xvJf linux-3.18.11.tar.xz
</code></pre>

<p>Rename the kernel directory:</p>
<pre><code class="shell">sudo mv linux-3.18.11 linux-3.18.11-rt
</code></pre>

<p>Change the directory into the unpacked kernel and patch it with RT PREEMPT.</p>
<pre><code class="shell">sudo -i
cd /usr/src/kernels/linux-3.18.11-rt/
sudo xz -dc /usr/src/kernels/patch-3.18.11-rt7.patch.xz | patch -p1
</code></pre>

<h2 id="cross-compiler_1">Cross-Compiler</h2>
<p>There is more than one ARM cross compilers for Ubuntu Linux. We will use the provided compiler from the <em>Raspberry Pi tools section</em> on GitHub.</p>
<pre><code class="shell">cd /opt/
git clone git://github.com/raspberrypi/tools.git --depth 1
</code></pre>

<h2 id="configuration_1">Configuration</h2>
<p>Before you are able to configure the kernel make sure you installed all necessary dependencies and get the linux kernel ready to compile:</p>
<pre><code class="shell">sudo apt-get install libncurses5-dev
make mrproper
</code></pre>

<p>We also need to copy the kernel <strong>.config file</strong> from the RPI into the build directory.
If there is a .config in the linux-3.18.11-rt folder file already, back it up. Then we will transfer the RPI .config from the embedded device onto the PC.</p>
<pre><code class="shell">cd /usr/src/kernels/linux-3.18.13-rt
sudo mv .config .config_backup
sudo rsync -avz -e ssh pi@141.7.25.81:/proc/config.gz /usr/src/kernels/linux-3.18.11-rt/.config
</code></pre>

<p>Set an environment variable for the prefix of the cross compiler toolchain:</p>
<pre><code class="shell">export CCPREFIX=/opt/rpi-tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/arm-linux-gnueabihf-
</code></pre>

<p>In the same terminal where you exported the environment variable run your first make command to configure your kernel:</p>
<pre><code class="shell">KERNEL=kernel7
sudo make ARCH=arm CROSS_COMPILE=${CCPREFIX} menuconfig
</code></pre>

<p>This make target will start up a graphical interface shown below: </p>
<p><img alt="" src="../gfx/Menuconfig_Start.png" /></p>
<p>For PC architectures the realtime settings are under <em>Processor type and features</em>. Select the <strong>Preemption Model</strong> and choose <strong>Fully Preemptible Kernel (RT)</strong> like in the screenshot below:
<img alt="" src="../gfx/Preemption_Model_menuconfig.png" /></p>
<p>If you configured the ARM build correctly the Preemption Model of the PREEMPT patch can be found under <em>Kernel Features</em> and then <strong>Preemption Model</strong> like shown in the following image:</p>
<p><img alt="" src="../gfx/Preemption_Model_menuconfig_ARM.png" /></p>
<p>Also choose <strong>Fully Preemptible Kernel (RT)</strong> here.</p>
<p><strong>Note:</strong> If this option is not available the patch was not successful and something went wrong. Try to patch the downloaded kernel once again.</p>
<h2 id="compiling_1">Compiling</h2>
<p>You can now compile the kernel on the PC. If you are working on a multi-processor platform enable parallel jobs for a quicker build switching on <em>-j #n</em> where #n is the number of parallel jobs that will be used. This should be 1.5 times your number of cores. Using this option makes the build about 48% faster on a modern Intel/AMD processor. Now you can imagine how long it would take to compile the kernel directly on the RPI itself (more than 3 hrs I guess).</p>
<pre><code class="shell">sudo make ARCH=arm CROSS_COMPILE=${CCPREFIX} -j5
</code></pre>

<p>Next we will build the modules</p>
<pre><code class="shell">sudo make ARCH=arm CROSS_COMPILE=${CCPREFIX} -j5 modules
</code></pre>

<p>After successful compilation the compiled kernel is located under <em>arch/arm/boot/</em>.
--&gt;</p>
<h1 id="references">References</h1>
<ul>
<li>http://elinux.org/Raspberry_Pi_Kernel_Compilation</li>
<li>https://www.raspberrypi.org/documentation/linux/kernel/building.md</li>
<li>https://www.osadl.org/?id=87</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../../ros/Installing-ROS/" class="btn btn-neutral" title="Installing ROS indigo"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Daniel Tuchscherer</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../../ros/Installing-ROS/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>

</body>
</html>
